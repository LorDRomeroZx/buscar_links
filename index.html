<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca de Scripts VFinal CR</title>
    <!-- Incluindo Tailwind CSS para um design moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              'primary': '#4f46e5', // Indigo
              'success': '#10b981', // Emerald
              'danger': '#ef4444', // Red
              'gemini': '#00BFFF', // Azul claro para Gemini
            }
          }
        }
      }
    </script>
    <style>
        /* Resetting default body margin for full Tailwind control */
        body { margin: 0; }
        
        /* Custom styling for the technical code preview area */
        #preview-area pre {
            background: #1f2937; /* Dark background for code */
            color: #f9fafb; /* Light text */
            padding: 1rem;
            border-radius: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid #374151;
        }

        /* Estilo para a resposta do Gemini */
        #gemini-explanation {
            border-left: 4px solid #00BFFF; /* Cor Gemini */
            background: #f0f8ff;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="font-sans bg-gray-50 min-h-screen flex items-start justify-center p-4 sm:p-8">
    
    <!-- Main Application Card -->
    <div class="bg-white shadow-2xl rounded-2xl p-6 sm:p-8 w-full max-w-xl mt-10">
        <h1 class="text-3xl font-extrabold text-primary mb-6 border-b pb-2">Busca de Scripts VFinal CR üíæ</h1>
        
        <!-- Form Inputs -->
        <div class="space-y-4">
            <div>
                <label for="sistema" class="block text-sm font-medium text-gray-700 mb-1">Sistema:</label>
                <select id="sistema" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="MediClinic">MediClinic</option>
                    <option value="Medisystem">Medisystem</option>
                    <option value="Mediweb">Mediweb</option>
                    <option value="Sislaudo">Sislaudo</option>
                </select>
            </div>
            
            <div>
                <label for="sgbd" class="block text-sm font-medium text-gray-700 mb-1">SGBD:</label>
                <select id="sgbd" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="firebird">Firebird</option>
                    <option value="PostgreSQL">PostgreSQL</option>
                    <option value="Oracle">Oracle</option>
                </select>
            </div>
            
            <label class="block text-sm font-medium text-gray-700">Intervalo de Scripts (M√°x. 4 D√≠gitos):</label>
            <div class="flex space-x-4">
                <input type="text" id="numero_inicio" placeholder="In√≠cio (ex: 001)" maxlength="4" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <input type="text" id="numero_fim" placeholder="Fim (ex: 488)" maxlength="4" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
            </div>

            <!-- üí° NOVO: Campo para Palavra-Chave -->
            <div>
                <label for="palavra_chave" class="block text-sm font-medium text-gray-700 mb-1">Palavra-Chave (Opcional):</label>
                <input type="text" id="palavra_chave" placeholder="Buscar por palavra-chave no conte√∫do" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex mt-6 space-x-3">
            <button onclick="buscarIntervalo()" class="flex-1 bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                Buscar Scripts no Intervalo
            </button>
            <button onclick="verificarUltimo()" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-150 shadow-md">
                Informa√ß√µes
            </button>
        </div>
        
        <!-- Results Area -->
        <div id="results" class="mt-8 border-t pt-6 space-y-3"></div>
        
        <!-- Preview Area -->
        <div id="preview-area" class="mt-8"></div>
        
    </div>

    <script>
        // URLs do seu servi√ßo Render. ATEN√á√ÉO: Use sempre a URL completa!
        const BASE_RENDER_URL = 'https://medilab-proxy-final.onrender.com';
        const PROXY_URL_BUSCA = `${BASE_RENDER_URL}/api/buscar-scripts`;
        const PROXY_URL_PREVIEW = `${BASE_RENDER_URL}/api/fetch-script`;
        
        const BASE_URL_SCRIPTS = 'http://medilab.tecnologia.ws/scriptsbd';
        
        // --- CONFIGURA√á√ÉO GEMINI ---
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
        const API_KEY = ""; // A chave API ser√° fornecida pelo ambiente de execu√ß√£o

        // üí° NOVO: Cache global para guardar o conte√∫do consolidado (para evitar erros de sintaxe no onclick)
        const consolidatedContentCache = {};

        /**
         * Faz a requisi√ß√£o para o servidor proxy e consolida os resultados.
         */
        async function buscarIntervalo() {
            const sistema = document.getElementById('sistema').value;
            const sgbd = document.getElementById('sgbd').value;
            
            const inicioStr = document.getElementById('numero_inicio').value;
            const fimStr = document.getElementById('numero_fim').value;
            
            const inicio = parseInt(inicioStr, 10);
            const fim = parseInt(fimStr, 10);

            // üí° NOVO: Captura a palavra-chave para filtragem
            const palavraChave = document.getElementById('palavra_chave').value.trim();
            
            if (isNaN(inicio) || isNaN(fim) || inicio > fim) {
                document.getElementById('results').innerHTML = '<p class="text-danger font-bold">‚ö†Ô∏è Por favor, insira um intervalo v√°lido (in√≠cio <= fim).</p>';
                return;
            }

            let html = `<h3 class="text-xl font-semibold mb-3">Scripts de ${inicio.toString().padStart(3, '0')} a ${fim.toString().padStart(3, '0')} (${sistema} / ${sgbd}):</h3>`;
            html += '<p class="text-yellow-600">‚è≥ Enviando requisi√ß√£o ao servidor proxy (Aguarde alguns segundos)...</p>';
            document.getElementById('results').innerHTML = html; 

            try {
                // Chama a rota de BUSCA (backend)
                const response = await fetch(PROXY_URL_BUSCA, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sistema, sgbd, inicio, fim })
                });

                const data = await response.json();

                if (!data.sucesso) {
                    document.getElementById('results').innerHTML = `<p class="text-danger font-bold">Erro no servidor: ${data.error || 'Falha desconhecida.'}</p>`;
                    return;
                }

                // Monta o HTML final e o conte√∫do consolidado
                let resultadosHTML = `<h3 class="text-xl font-semibold mb-3">Scripts de ${inicio.toString().padStart(3, '0')} a ${fim.toString().padStart(3, '0')} (${sistema} / ${sgbd}):</h3>`;
                let conteudoConsolidado = '';
                let scriptsDisponiveis = 0;
                let scriptsFiltrados = 0; // Novo contador para scripts que correspondem √† palavra-chave

                // Processa e filtra os resultados do servidor
                data.data.forEach(res => {
                    const isDisponivel = (res.status === 'Dispon√≠vel');
                    let isMatch = true;

                    // üí° L√≥gica de Filtragem por Palavra-Chave
                    if (isDisponivel && palavraChave) {
                        // Faz a pesquisa case-insensitive no conte√∫do do script
                        const contentLower = (res.conteudo || '').toLowerCase();
                        const keywordLower = palavraChave.toLowerCase();
                        if (!contentLower.includes(keywordLower)) {
                            isMatch = false; // N√£o corresponde √† palavra-chave
                        }
                    }

                    if (isDisponivel) {
                        scriptsDisponiveis++;
                    }

                    // Apenas exibe scripts dispon√≠veis ou indispon√≠veis (se n√£o houver palavra-chave)
                    // Se houver palavra-chave, s√≥ exibe se for 'Dispon√≠vel' E houver 'Match'
                    
                    if (isDisponivel) {
                        if (isMatch) {
                            scriptsFiltrados++;
                            const url = `${BASE_URL_SCRIPTS}/${sistema}/${sgbd}/script${res.numero}.txt`;
                            
                            // Item de resultado moderno com Tailwind classes
                            resultadosHTML += `
                                <div class="flex items-center justify-between bg-green-50 p-3 rounded-lg border-l-4 border-success shadow-sm">
                                    <span class="text-sm font-medium text-gray-800">‚úÖ Script ${res.numero} (Dispon√≠vel)</span>
                                    <div class="space-x-2">
                                        <a href="${url}" target="_blank" class="text-xs bg-success text-white py-1 px-3 rounded-full hover:bg-emerald-600 transition">Baixar</a>
                                        <button class="text-xs bg-primary text-white py-1 px-3 rounded-full hover:bg-indigo-600 transition" onclick="previsualizarScript('${url}', '${res.numero}')">Pr√©-visualizar</button>
                                    </div>
                                </div>
                            `;

                            // Adiciona ao conte√∫do consolidado SOMENTE se for um match
                            const separador = `-- ========================================================================= --`;
                            conteudoConsolidado += `\n${separador}\n-- IN√çCIO SCRIPT ${res.numero} (${sistema}/${sgbd}) --\n${separador}\n`;
                            conteudoConsolidado += res.conteudo;
                            conteudoConsolidado += `\n${separador}\n-- FIM SCRIPT ${res.numero} --\n${separador}\n`;
                        }
                        // Se for Dispon√≠vel, mas N√ÉO for Match, √© ignorado da lista
                    } else {
                        // Scripts indispon√≠veis sempre s√£o mostrados, independentemente da palavra-chave (pois n√£o t√™m conte√∫do para buscar)
                        resultadosHTML += `<div class="bg-red-50 p-3 rounded-lg border-l-4 border-danger shadow-sm">
                            <span class="text-sm font-medium text-red-700">‚ùå Script ${res.numero} (${res.status})</span>
                        </div>`;
                    }
                });

                // Adiciona o bot√£o de pr√©-visualiza√ß√£o consolidada
                if (scriptsFiltrados > 0) {
                    // üí° NOVO: Cria uma chave √∫nica para a cache
                    const cacheKey = `${sistema}-${sgbd}-${inicioStr}-${fimStr}-${palavraChave}`; // Chave inclui a palavra-chave
                    // üí° NOVO: Armazena o conte√∫do completo (sem codificar) na cache
                    consolidatedContentCache[cacheKey] = conteudoConsolidado; 
                    
                    // Passa apenas a chave para a fun√ß√£o (prevenindo SyntaxError)
                    resultadosHTML += `<button onclick="previsualizarConsolidado('${cacheKey}', '${scriptsFiltrados}', '${sistema}', '${sgbd}', '${inicioStr}', '${fimStr}')" class="w-full bg-success text-white font-semibold py-3 px-4 rounded-lg hover:bg-emerald-600 transition duration-150 shadow-lg mt-6">üìÑ Pr√©-visualiza√ß√£o Consolidada (${scriptsFiltrados} Scripts)</button>`;
                } else if (scriptsDisponiveis > 0 && palavraChave) {
                    // Caso tenha scripts dispon√≠veis, mas nenhum corresponda √† palavra-chave
                    resultadosHTML += `<p class="text-danger font-bold mt-4">Nenhum script dispon√≠vel no intervalo corresponde √† palavra-chave: "${palavraChave}".</p>`;
                } else {
                    document.getElementById('preview-area').innerHTML = ''; // Limpa a pr√©-visualiza√ß√£o
                    resultadosHTML += `<p class="text-danger font-bold mt-4">Nenhum script dispon√≠vel no intervalo.</p>`;
                }

                document.getElementById('results').innerHTML = resultadosHTML;

            } catch (error) {
                // Mensagem de erro atualizada para n√£o mencionar o localhost
                document.getElementById('results').innerHTML = `<p class="text-danger font-bold">üî¥ Erro ao acessar o servidor na nuvem. Verifique se o servi√ßo Render est√° ativo. (${error.message})</p>`;
            }
        }

        /**
         * Pr√©-visualiza o conte√∫do de TODOS os scripts de forma consolidada.
         */
        function previsualizarConsolidado(cacheKey, count, sistema, sgbd, inicio, fim) {
            const previewArea = document.getElementById('preview-area');
            
            // üí° NOVO: Recupera o conte√∫do diretamente da cache
            const conteudo = consolidatedContentCache[cacheKey];

            // Verifica se o conte√∫do est√° vazio (diagn√≥stico de falha do servidor)
            if (!conteudo || conteudo.trim().length < 10) {
                 previewArea.innerHTML = `<p class="text-danger font-bold">‚ö†Ô∏è Erro na Pr√©-visualiza√ß√£o: O servidor Render n√£o retornou conte√∫do. O servi√ßo pode estar em sleep ou a conex√£o falhou.</p>`;
                 return;
            }

            // O conte√∫do √© a string limpa, vamos codific√°-la apenas para a fun√ß√£o de download
            const downloadConteudo = encodeURIComponent(conteudo);
            
            // Exibe o conte√∫do na √°rea de pr√©-visualiza√ß√£o
            previewArea.innerHTML = `
                <h4 class="text-xl font-semibold mb-3 text-primary border-b pb-2">üìÑ Pr√©-visualiza√ß√£o Consolidada (${count} Scripts)</h4>
                <pre>
                    ${conteudo}
                </pre>
                
                <!-- Adiciona a op√ß√£o de baixar o arquivo consolidado aqui -->
                <button onclick="baixarConsolidado('${downloadConteudo}', '${sistema}', '${sgbd}', '${inicio}', '${fim}')" class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-150 shadow-md mt-4">üíæ Baixar Ficheiro Consolidado (.txt)</button>
            `;
        }

        /**
         * Busca o script via proxy e exibe o conte√∫do na √°rea de pr√©-visualiza√ß√£o.
         */
        async function previsualizarScript(url, numero) {
            const previewArea = document.getElementById('preview-area');
            previewArea.innerHTML = `<p class="text-indigo-600">‚è≥ Buscando conte√∫do do Script ${numero} via Render...</p>`;
            
            try {
                // Chama a rota de PREVIEW (backend)
                const response = await fetch(PROXY_URL_PREVIEW, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url }) // Envia a URL do script para o proxy
                });

                const data = await response.json();

                if (data.sucesso) {
                    const scriptContent = data.content || "Conte√∫do indispon√≠vel.";
                    const encodedContent = encodeURIComponent(scriptContent);
                    
                    previewArea.innerHTML = `
                        <h4 class="text-xl font-semibold mb-3 text-primary border-b pb-2">üìÑ Pr√©-visualiza√ß√£o do Script ${numero}</h4>
                        <div class="flex space-x-2 mb-3">
                            <button class="text-xs bg-gemini text-white font-semibold py-1 px-3 rounded-full hover:bg-sky-600 transition shadow-md" onclick="explicarScriptGemini('${encodedContent}', '${numero}')">
                                ‚ú® Explicar Script (Gemini)
                            </button>
                        </div>
                        <pre id="script-content-display">
                            ${scriptContent}
                        </pre>
                        <div id="gemini-explanation-${numero}"></div>
                    `;
                } else {
                    previewArea.innerHTML = `<p class="text-danger font-bold">Falha ao carregar a pr√©-visualiza√ß√£o: ${data.error || 'Erro desconhecido.'}</p>`;
                }
            } catch (error) {
                previewArea.innerHTML = `<p class="text-danger font-bold">üî¥ Erro de conex√£o com o proxy durante a pr√©-visualiza√ß√£o. (${error.message})</p>`;
            }
        }

        /**
         * NOVA FUN√á√ÉO: Chama a API Gemini para analisar o script SQL.
         */
        async function explicarScriptGemini(encodedContent, numero) {
            const explanationArea = document.getElementById(`gemini-explanation-${numero}`);
            
            // 1. Decodificar o conte√∫do do script
            const scriptContent = decodeURIComponent(encodedContent);
            
            // 2. Mostrar estado de carregamento
            explanationArea.innerHTML = `<div class="text-center py-4 text-indigo-500">
                Analisando o Script ${numero} com a IA...
            </div>`;

            // 3. Configurar o Payload da API Gemini
            const systemPrompt = "Aja como um analista de banco de dados SQL. Seu objetivo √© resumir o prop√≥sito do script SQL fornecido (DML ou DDL) em portugu√™s de Portugal. Seja conciso e liste o que o script faz e qual √© o seu impacto potencial (por exemplo, altera a estrutura da tabela X, ou atualiza registros na tabela Y). Use Markdown para formatar a resposta.";
            const userQuery = `Analise o seguinte script SQL:\n\n${scriptContent}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                // 4. Chamar a API Gemini
                const response = await fetch(GEMINI_API_URL + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Erro ao gerar explica√ß√£o. A resposta da IA estava vazia.";
                
                // 5. Exibir a explica√ß√£o
                explanationArea.innerHTML = `
                    <div id="gemini-explanation" class="mt-4">
                        <h5 class="font-bold text-gemini mb-2">‚ú® An√°lise Gemini: Script ${numero}</h5>
                        <p class="whitespace-pre-wrap">${text}</p>
                    </div>
                `;

            } catch (error) {
                explanationArea.innerHTML = `<p class="text-danger font-bold mt-4">Falha na conex√£o com a API Gemini: ${error.message}</p>`;
            }
        }


        /**
         * Fun√ß√£o auxiliar para gerar e iniciar o download do arquivo consolidado.
         */
        function baixarConsolidado(conteudoCodificado, sistema, sgbd, inicio, fim) {
            // Reverte o encoding para obter o conte√∫do
            const conteudo = decodeURIComponent(conteudoCodificado);
            
            // Recalcula os metadados do nome do ficheiro (baseado na √∫ltima pesquisa, ou usa placeholders)
            const sistemaNome = sistema || document.getElementById('sistema').value;
            const sgbdNome = sgbd || document.getElementById('sgbd').value;
            const inicioNumero = inicio || document.getElementById('numero_inicio').value.padStart(3, '0');
            const fimNumero = fim || document.getElementById('numero_fim').value.padStart(3, '0');
            
            // --- NOVO DIAGN√ìSTICO: Verifica se o conte√∫do est√° vazio ---
            if (!conteudo || conteudo.trim().length === 0 || conteudo.trim().length < 10) {
                // Exibe uma mensagem de erro tempor√°ria para o usu√°rio
                document.getElementById('preview-area').insertAdjacentHTML('afterend',
                    '<p id="download-error" class="text-danger font-bold text-center mt-4">‚ö†Ô∏è Erro no Download: Conte√∫do vazio. O servidor Render n√£o forneceu os dados.</p>');
                
                // Remove a mensagem ap√≥s 5 segundos
                setTimeout(() => {
                    const errorElem = document.getElementById('download-error');
                    if (errorElem) errorElem.remove();
                }, 5000);
                return;
            }
            // --- FIM DO NOVO DIAGN√ìSTICO ---
            
            const nomeArquivo = `${sistemaNome}-${sgbdNome}-scripts_${inicioNumero}_${fimNumero}.txt`;
            
            // Cria um objeto Blob (Binary Large Object) com o conte√∫do
            const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
            
            // Cria um link tempor√°rio para iniciar o download
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            
            // Dispara o clique e limpa o URL do objeto
            a.click(); 
            URL.revokeObjectURL(url);
        }
        
        // Mantemos a fun√ß√£o informativa para o outro bot√£o
        function verificarUltimo() {
            const mensagem = `
                <h3 class="text-xl font-semibold text-primary mb-3">‚úÖ Verifica√ß√£o Habilitada</h3>
                <p>O servidor proxy (Node.js) agora est√° fazendo a verifica√ß√£o de disponibilidade. Se a busca n√£o retornar erros de conex√£o, as mensagens **(Dispon√≠vel)** ou **(N√£o encontrado)** ser√£o confi√°veis.</p>
            `;
            document.getElementById('results').innerHTML = mensagem;
        }
    </script>
</body>
</html>
