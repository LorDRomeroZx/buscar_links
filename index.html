<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca de Scripts VFinal CR</title>
    <!-- Incluindo Tailwind CSS para um design moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              'primary': '#4f46e5', // Indigo
              'success': '#10b981', // Emerald
              'danger': '#ef4444', // Red
            }
          }
        }
      }
    </script>
    <style>
        /* Resetting default body margin for full Tailwind control */
        body { margin: 0; }
        
        /* Custom styling for the technical code preview area */
        #preview-area pre {
            background: #1f2937; /* Dark background for code */
            color: #f9fafb; /* Light text */
            padding: 1rem;
            border-radius: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid #374151;
        }
    </style>
</head>
<body class="font-sans bg-gray-50 min-h-screen flex items-start justify-center p-4 sm:p-8">
    
    <!-- Main Application Card -->
    <div class="bg-white shadow-2xl rounded-2xl p-6 sm:p-8 w-full max-w-xl mt-10">
        <h1 class="text-3xl font-extrabold text-primary mb-6 border-b pb-2">Busca de Scripts VFinal CR üíæ</h1>
        
        <!-- Form Inputs -->
        <div class="space-y-4">
            <div>
                <label for="sistema" class="block text-sm font-medium text-gray-700 mb-1">Sistema:</label>
                <select id="sistema" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="MediClinic">MediClinic</option>
                    <option value="Medisystem">Medisystem</option>
                    <option value="Mediweb">Mediweb</option>
                    <option value="Sislaudo">Sislaudo</option>
                </select>
            </div>
            
            <div>
                <label for="sgbd" class="block text-sm font-medium text-gray-700 mb-1">SGBD:</label>
                <select id="sgbd" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="firebird">Firebird</option>
                    <option value="PostgreSQL">PostgreSQL</option>
                    <option value="Oracle">Oracle</option>
                </select>
            </div>
            
            <label class="block text-sm font-medium text-gray-700">Intervalo de Scripts (M√°x. 4 D√≠gitos):</label>
            <div class="flex space-x-4">
                <input type="text" id="numero_inicio" placeholder="In√≠cio (ex: 001)" maxlength="4" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <input type="text" id="numero_fim" placeholder="Fim (ex: 488)" maxlength="4" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex mt-6 space-x-3">
            <button onclick="buscarIntervalo()" class="flex-1 bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                Buscar Scripts no Intervalo
            </button>
            <button onclick="verificarUltimo()" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-150 shadow-md">
                Informa√ß√µes
            </button>
        </div>
        
        <!-- Results Area -->
        <div id="results" class="mt-8 border-t pt-6 space-y-3"></div>
        
        <!-- Preview Area -->
        <div id="preview-area" class="mt-8"></div>
        
    </div>

    <script>
        // URLs do seu servi√ßo Render. ATEN√á√ÉO: Use sempre a URL completa!
        const BASE_RENDER_URL = 'https://medilab-proxy-final.onrender.com';
        const PROXY_URL_BUSCA = `${BASE_RENDER_URL}/api/buscar-scripts`;
        const PROXY_URL_PREVIEW = `${BASE_RENDER_URL}/api/fetch-script`;
        
        const BASE_URL_SCRIPTS = 'http://medilab.tecnologia.ws/scriptsbd';

        /**
         * Faz a requisi√ß√£o para o servidor proxy e consolida os resultados.
         */
        async function buscarIntervalo() {
            const sistema = document.getElementById('sistema').value;
            const sgbd = document.getElementById('sgbd').value;
            
            const inicioStr = document.getElementById('numero_inicio').value;
            const fimStr = document.getElementById('numero_fim').value;
            
            const inicio = parseInt(inicioStr, 10);
            const fim = parseInt(fimStr, 10);
            
            if (isNaN(inicio) || isNaN(fim) || inicio > fim) {
                document.getElementById('results').innerHTML = '<p class="text-danger font-bold">‚ö†Ô∏è Por favor, insira um intervalo v√°lido (in√≠cio <= fim).</p>';
                return;
            }

            let html = `<h3 class="text-xl font-semibold mb-3">Scripts de ${inicio.toString().padStart(3, '0')} a ${fim.toString().padStart(3, '0')} (${sistema} / ${sgbd}):</h3>`;
            html += '<p class="text-yellow-600">‚è≥ Enviando requisi√ß√£o ao servidor proxy (Aguarde alguns segundos)...</p>';
            document.getElementById('results').innerHTML = html; 

            try {
                // Chama a rota de BUSCA (backend)
                const response = await fetch(PROXY_URL_BUSCA, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sistema, sgbd, inicio, fim })
                });

                const data = await response.json();

                if (!data.sucesso) {
                    document.getElementById('results').innerHTML = `<p class="text-danger font-bold">Erro no servidor: ${data.error || 'Falha desconhecida.'}</p>`;
                    return;
                }

                // Monta o HTML final e o conte√∫do consolidado
                let resultadosHTML = `<h3 class="text-xl font-semibold mb-3">Scripts de ${inicio.toString().padStart(3, '0')} a ${fim.toString().padStart(3, '0')} (${sistema} / ${sgbd}):</h3>`;
                let conteudoConsolidado = '';
                let scriptsDisponiveis = 0;

                data.data.forEach(res => {
                    if (res.status === 'Dispon√≠vel') {
                        const url = `${BASE_URL_SCRIPTS}/${sistema}/${sgbd}/script${res.numero}.txt`;
                        
                        // Item de resultado moderno com Tailwind classes
                        resultadosHTML += `
                            <div class="flex items-center justify-between bg-green-50 p-3 rounded-lg border-l-4 border-success shadow-sm">
                                <span class="text-sm font-medium text-gray-800">‚úÖ Script ${res.numero} (Dispon√≠vel)</span>
                                <div class="space-x-2">
                                    <a href="${url}" target="_blank" class="text-xs bg-success text-white py-1 px-3 rounded-full hover:bg-emerald-600 transition">Baixar</a>
                                    <button class="text-xs bg-primary text-white py-1 px-3 rounded-full hover:bg-indigo-600 transition" onclick="previsualizarScript('${url}', '${res.numero}')">Pr√©-visualizar</button>
                                </div>
                            </div>
                        `;

                        // Conte√∫do para o download consolidado (retirado do Render)
                        conteudoConsolidado += `\n\n--- IN√çCIO SCRIPT ${res.numero} ---\n`;
                        conteudoConsolidado += res.conteudo;
                        conteudoConsolidado += `\n--- FIM SCRIPT ${res.numero} ---`;
                        scriptsDisponiveis++;
                    } else {
                        // Item de erro moderno
                        resultadosHTML += `<div class="bg-red-50 p-3 rounded-lg border-l-4 border-danger shadow-sm">
                            <span class="text-sm font-medium text-red-700">‚ùå Script ${res.numero} (${res.status})</span>
                        </div>`;
                    }
                });

                // Adiciona o bot√£o de download consolidado
                if (scriptsDisponiveis > 0) {
                    // Usamos JSON.stringify para garantir que a string seja passada corretamente para o onclick, resolvendo poss√≠veis erros de sintaxe de aspas/caracteres.
                    const seguroConteudo = JSON.stringify(conteudoConsolidado);
                    
                    resultadosHTML += `<button onclick='baixarConsolidado(${seguroConteudo}, "${sistema}", "${sgbd}", "${inicioStr}", "${fimStr}")' class="w-full bg-secondary text-white font-semibold py-3 px-4 rounded-lg hover:bg-emerald-600 transition duration-150 shadow-lg mt-6">üíæ Baixar Conte√∫do Consolidado (${scriptsDisponiveis} Scripts)</button>`;
                } else {
                    document.getElementById('preview-area').innerHTML = ''; // Limpa a pr√©-visualiza√ß√£o
                    resultadosHTML += `<p class="text-danger font-bold mt-4">Nenhum script dispon√≠vel no intervalo.</p>`;
                }

                document.getElementById('results').innerHTML = resultadosHTML;

            } catch (error) {
                // Mensagem de erro atualizada para n√£o mencionar o localhost
                document.getElementById('results').innerHTML = `<p class="text-danger font-bold">üî¥ Erro ao acessar o servidor na nuvem. Verifique se o servi√ßo Render est√° ativo. (${error.message})</p>`;
            }
        }

        /**
         * NOVA FUN√á√ÉO: Busca o script via proxy e exibe o conte√∫do na √°rea de pr√©-visualiza√ß√£o.
         */
        async function previsualizarScript(url, numero) {
            const previewArea = document.getElementById('preview-area');
            previewArea.innerHTML = `<p class="text-indigo-600">‚è≥ Buscando conte√∫do do Script ${numero} via Render...</p>`;
            
            try {
                // Chama a rota de PREVIEW (backend)
                const response = await fetch(PROXY_URL_PREVIEW, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url }) // Envia a URL do script para o proxy
                });

                const data = await response.json();

                if (data.sucesso) {
                    previewArea.innerHTML = `
                        <h4 class="text-xl font-semibold mb-3 text-primary border-b pb-2">üìÑ Pr√©-visualiza√ß√£o do Script ${numero}</h4>
                        <pre>
                            ${data.content}
                        </pre>
                    `;
                } else {
                    previewArea.innerHTML = `<p class="text-danger font-bold">Falha ao carregar a pr√©-visualiza√ß√£o: ${data.error || 'Erro desconhecido.'}</p>`;
                }
            } catch (error) {
                previewArea.innerHTML = `<p class="text-danger font-bold">üî¥ Erro de conex√£o com o proxy durante a pr√©-visualiza√ß√£o. (${error.message})</p>`;
            }
        }

        /**
         * Fun√ß√£o auxiliar para gerar e iniciar o download do arquivo consolidado.
         */
        function baixarConsolidado(conteudoConsolidadoJson, sistema, sgbd, inicio, fim) {
            // Se a string foi passada via JSON.stringify, ela deve ser parseada:
            const conteudo = JSON.parse(conteudoConsolidadoJson);
            
            // --- NOVO DIAGN√ìSTICO: Verifica se o conte√∫do est√° vazio ---
            if (!conteudo || conteudo.trim().length === 0 || conteudo.trim().length < 10) {
                // Exibe uma mensagem de erro tempor√°ria para o usu√°rio
                document.getElementById('results').insertAdjacentHTML('afterend',
                    '<p id="download-error" class="text-danger font-bold text-center mt-4">‚ö†Ô∏è Erro no Download: Conte√∫do vazio. Verifique se o servidor Render retornou dados.</p>');
                
                // Remove a mensagem ap√≥s 5 segundos
                setTimeout(() => {
                    const errorElem = document.getElementById('download-error');
                    if (errorElem) errorElem.remove();
                }, 5000);
                return;
            }
            // --- FIM DO NOVO DIAGN√ìSTICO ---
            
            const nomeArquivo = `${sistema}-${sgbd}-scripts_${inicio}_${fim}.txt`;
            
            // Cria um objeto Blob (Binary Large Object) com o conte√∫do
            const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
            
            // Cria um link tempor√°rio para iniciar o download
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click(); // Dispara o download
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Mantemos a fun√ß√£o informativa para o outro bot√£o
        function verificarUltimo() {
            const mensagem = `
                <h3 class="text-xl font-semibold text-primary mb-3">‚úÖ Verifica√ß√£o Habilitada</h3>
                <p>O servidor proxy (Node.js) agora est√° fazendo a verifica√ß√£o de disponibilidade. Se a busca n√£o retornar erros de conex√£o, as mensagens **(Dispon√≠vel)** ou **(N√£o encontrado)** ser√£o confi√°veis.</p>
            `;
            document.getElementById('results').innerHTML = mensagem;
        }
    </script>
</body>
</html>
